<!DOCTYPE html>
<html>

<head>
  <title>Streaming TTS Reader</title>
</head>

<body>
  <h2>Streaming Read Website Aloud</h2>
  <input type="text" id="url" placeholder="Enter article URL" size="50" />
  <select id="voice">
    <option value="shimmer">Shimmer (Sky)</option>
    <option value="onyx">Onyx (Ember)</option>
    <option value="nova">Nova (Cove)</option>
    <option value="echo">Echo (Breeze)</option>
    <option value="fable">Fable (Juniper)</option>
  </select>
  <button id="readBtn">Read</button>
  <br /><br />
  <audio id="player" controls></audio>

  <script>
    const readBtn = document.getElementById("readBtn");
    const urlInput = document.getElementById("url");
    const voiceSelect = document.getElementById("voice");
    const player = document.getElementById("player");

    let audioQueue = [];
    let isPlaying = false;
    let eventSource = null;

    readBtn.onclick = () => {
      const articleUrl = urlInput.value.trim();
      const selectedVoice = voiceSelect.value;

      if (!articleUrl) {
        alert("Please enter a URL");
        return;
      }

      audioQueue = [];
      isPlaying = false;
      player.src = "";

      readBtn.disabled = true;
      readBtn.textContent = "Loading...";

      // Construct stream-read URL with query parameters
      const streamUrl = new URL("/stream-read", window.location.origin);
      streamUrl.searchParams.set("url", articleUrl);
      streamUrl.searchParams.set("voice", selectedVoice);

      eventSource = new EventSource(streamUrl);

      eventSource.onopen = () => {
        console.log("Streaming connection opened");
      };

      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.audioUrl) {
          audioQueue.push(data.audioUrl);
          if (!isPlaying) {
            playNext();
          }
        }
      };

      eventSource.addEventListener("end", () => {
        console.log("Streaming ended");
        eventSource.close();
        readBtn.disabled = false;
        readBtn.textContent = "Read";
      });

      eventSource.addEventListener("error", (event) => {
        try {
          const errorData = JSON.parse(event.data);
          alert("Error: " + errorData.error);
        } catch {
          alert("A streaming error occurred");
        }
        eventSource.close();
        readBtn.disabled = false;
        readBtn.textContent = "Read";
      });

      function playNext() {
        if (audioQueue.length === 0) {
          isPlaying = false;
          return;
        }
        isPlaying = true;
        const nextAudio = audioQueue.shift();
        player.src = nextAudio;
        player.play();
      }

      player.onended = () => {
        playNext();
      };
    };
  </script>
</body>

</html>